<div class="page-wrapper">
  @let colorData = getGroupColorClasses();
  <app-form-header
    [colorData]="colorData"
    [title]="
      isDuplicateMode ? 'Duplicate Checklist' : isEditMode ? 'Edit Checklist' : 'Add Checklist'
    "
  >
    <app-back-button
      slot="left-buttons"
      (back)="goBack()"
      [colorData]="colorData"
    ></app-back-button>
  </app-form-header>
  <div class="flex-1 overflow-y-auto px-4 py-6">
    <form [formGroup]="form" class="flex flex-col w-full">
      <!-- Title Field -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <mat-icon [class]="'text-base! ' + colorData.textClass">title</mat-icon>
          Checklist Title
        </label>
        <mat-form-field
          appearance="outline"
          class="w-full"
          [style.--mat-form-field-outlined-focus-outline-color]="colorData.textColorValue"
        >
          <input
            matInput
            formControlName="title"
            placeholder="Enter a descriptive title for your checklist"
            class="text-base"
          />
          @if (form.get('title')?.hasError('required') && form.get('title')?.touched) {
            <mat-error>Title is required</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Icon Field -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <mat-icon [class]="'text-base! ' + colorData.textClass">palette</mat-icon>
          Icon
        </label>
        <mat-form-field
          appearance="outline"
          class="w-full"
          [style.--mat-form-field-outlined-focus-outline-color]="colorData.textColorValue"
        >
          <mat-select formControlName="icon">
            <mat-select-trigger>
              @if (getSelectedIcon(); as selectedIcon) {
                <div class="flex items-center gap-3 py-1">
                  <mat-icon [class]="colorData.textClass">{{ selectedIcon.value }}</mat-icon>
                  <span class="font-medium">{{ selectedIcon.label }}</span>
                </div>
              }
            </mat-select-trigger>
            @for (icon of icons; track icon.value) {
              <mat-option [value]="icon.value">
                <div class="flex items-center gap-3 py-1">
                  <mat-icon class="text-gray-600">{{ icon.value }}</mat-icon>
                  <span>{{ icon.label }}</span>
                </div>
              </mat-option>
            }
          </mat-select>
          @if (form.get('icon')?.hasError('required') && form.get('icon')?.touched) {
            <mat-error>Icon is required</mat-error>
          }
        </mat-form-field>
      </div>

      <!-- Color Field -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <mat-icon [class]="'text-base! ' + colorData.textClass">color_lens</mat-icon>
          Color Theme
        </label>
        <div class="w-full">
          <app-color-picker [colors]="colorOptions" formControlName="color"></app-color-picker>
          @if (form.get('color')?.hasError('required') && form.get('color')?.touched) {
            <div class="text-xs text-red-600 mt-1 ml-1">Color is required</div>
          }
        </div>
      </div>

      <!-- Group Field -->
      <div class="space-y-2">
        <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
          <mat-icon [class]="'text-base! ' + colorData.textClass">folder</mat-icon>
          Group (Optional)
        </label>
        <mat-form-field
          appearance="outline"
          class="w-full"
          [style.--mat-form-field-outlined-focus-outline-color]="colorData.textColorValue"
        >
          <mat-select formControlName="groupId" placeholder="Select a group (optional)">
            <mat-select-trigger>
              @if (getSelectedGroup(); as selectedGroup) {
                <div class="flex items-center gap-3 py-1">
                  @if (selectedGroup.icon) {
                    <mat-icon [class]="colorData.textClass">{{ selectedGroup.icon }}</mat-icon>
                  } @else {
                    <mat-icon [class]="colorData.textClass">folder</mat-icon>
                  }
                  <span class="font-medium">{{ selectedGroup.title }}</span>
                </div>
              } @else {
                <span class="text-gray-500">No Group</span>
              }
            </mat-select-trigger>
            <mat-option [value]="null">
              <span class="text-gray-500">No Group</span>
            </mat-option>
            @for (group of checklistGroups; track group.id) {
              <mat-option [value]="group.id">
                <div class="flex items-center gap-3 py-1">
                  @if (group.icon) {
                    <mat-icon class="text-gray-600">{{ group.icon }}</mat-icon>
                  } @else {
                    <mat-icon class="text-gray-600">folder</mat-icon>
                  }
                  <span>{{ group.title }}</span>
                </div>
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Preview Section -->
      @if (form.get('title')?.value || form.get('icon')?.value || form.get('color')?.value) {
        <div class="p-4 rounded-xl border-2 border-dashed border-gray-200 bg-gray-50">
          <p class="text-xs font-semibold text-gray-500 uppercase mb-4">Preview</p>
          @let colorClasses = getSelectedColor();
          @let defaultColorClasses =
            {
              bgClass: 'bg-primary-500/20',
              borderClass: 'border-primary',
              textClass: 'text-primary',
            };
          @let previewColorClasses = colorClasses || defaultColorClasses;
          <div
            class="max-w-36 rounded-xl p-6 transition-colors duration-300 flex flex-col items-center justify-center relative backdrop-blur-sm"
            [class]="
              previewColorClasses.bgClass +
              ' ' +
              previewColorClasses.borderClass +
              ' ' +
              previewColorClasses.textClass
            "
          >
            <div class="md:mb-1">
              <mat-icon class="text-3xl! w-8! flex h-8! md:text-4xl! md:w-10! md:h-10!">
                {{ getSelectedIcon()?.value || 'checklist' }}
              </mat-icon>
            </div>
            <div class="text-sm sm:text-lg font-medium text-center wrap-break-word">
              {{ form.get('title')?.value || 'Your Checklist Title' }}
            </div>
          </div>
        </div>
      }
    </form>
  </div>

  <div class="-ml-6 -mr-6 mt-6 px-10 pt-4 pb-6 bg-gray-50 border-t border-gray-200 rounded-b-lg">
    <div class="flex items-center gap-3 w-full justify-end">
      <button
        mat-button
        (click)="goBack()"
        class="px-6 py-2 font-medium text-gray-600 hover:bg-gray-100"
      >
        <mat-icon class="text-lg">close</mat-icon>
        <span>Cancel</span>
      </button>
      @if (isDuplicateMode) {
        <button
          mat-raised-button
          (click)="onDuplicate()"
          [disabled]="!form.valid"
          [class]="colorData.bgClass"
          [style.background-color]="getGroupColor()"
          [style.color]="'white'"
          class="px-6 py-2 font-semibold shadow-md hover:shadow-lg transition-shadow"
        >
          <mat-icon class="text-lg">content_copy</mat-icon>
          <span>Duplicate Checklist</span>
        </button>
      } @else {
        <button
          mat-raised-button
          (click)="isEditMode ? onSave() : onCreate()"
          [disabled]="!form.valid"
          [style.background-color]="colorData.textColorValue"
          [style.color]="'white'"
          class="px-6 py-2 font-semibold shadow-md hover:shadow-lg transition-shadow"
        >
          <mat-icon class="text-lg">{{ isEditMode ? 'save' : 'add_circle' }}</mat-icon>
          <span>{{ isEditMode ? 'Save Changes' : 'Create Checklist' }}</span>
        </button>
      }
    </div>
  </div>
</div>
