<div class="page-wrapper" (click)="closeSwipe()">
  @let colorData = getChecklistColorData();
  <app-page-header [colorData]="colorData" [icon]="checklist()?.icon" [title]="checklist()?.title">
    <app-back-button
      slot="left-buttons"
      (back)="goBack()"
      [colorData]="colorData"
    ></app-back-button>
    <div slot="right-buttons" class="flex items-center gap-2 sm:gap-3">
      <app-add-button
        label="Add Item"
        icon="add"
        (add)="openNewItemDialog()"
        [colorData]="colorData"
      ></app-add-button>
    </div>
  </app-page-header>

  @if (isLoading()) {
    <div class="text-center py-4 text-gray-600 flex-1 flex flex-col justify-center">
      Loading checklist items...
    </div>
  } @else if (checklistItems().length === 0) {
    <div class="text-center py-4 px-8 text-gray-600 flex-1 flex flex-col justify-center">
      <mat-icon class="text-6xl! w-16! h-16! text-gray-300! mb-4! block! mx-auto!">
        block
      </mat-icon>
      <p class="m-0 text-gray-500">No items in the checklist yet.</p>
    </div>
  } @else {
    @if (checklistItems().length > 0) {
      <div
        class="mt-2 sm:mt-4 mb-4 sm:mb-6 flex justify-between items-center gap-2 px-2 sm:px-4 py-2"
      >
        <div class="flex items-center gap-2">
          <button
            mat-icon-button
            [style.background-color]="
              dragDropEnabled() ? checklist()?.color + '20' : 'var(--color-gray-100)'
            "
            [style.color]="dragDropEnabled() ? colorData.textColorValue : 'var(--color-gray-500)'"
            [class.opacity-70!]="!dragDropEnabled()"
            (click)="toggleDragDrop()"
            aria-label="Toggle drag and drop"
            [attr.title]="dragDropEnabled() ? 'Disable drag and drop' : 'Enable drag and drop'"
            class="transition-all rounded-lg"
          >
            <mat-icon>drag_indicator</mat-icon>
          </button>
          <button
            mat-icon-button
            [style.background-color]="
              sortByDoneEnabled() ? checklist()?.color + '20' : 'var(--color-gray-100)'
            "
            [style.color]="sortByDoneEnabled() ? colorData.textColorValue : 'var(--color-gray-500)'"
            [class.opacity-70!]="!sortByDoneEnabled()"
            (click)="toggleSortByDone()"
            aria-label="Toggle sort by done"
            [attr.title]="sortByDoneEnabled() ? 'Disable sort by done' : 'Enable sort by done'"
            class="transition-all rounded-lg"
          >
            <mat-icon>low_priority</mat-icon>
          </button>
          <button
            mat-icon-button
            class="bg-gray-100! text-gray-500! opacity-70! transition-all rounded-lg"
            (click)="resetChecklistItems()"
            aria-label="Reset checklist items"
            title="Reset checklist items"
          >
            <mat-icon>replay</mat-icon>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <div class="flex gap-1 bg-gray-100 rounded-4xl p-1 border border-gray-200">
            <button
              mat-icon-button
              [class.bg-white!]="layoutMode() === 'compact'"
              [class]="layoutMode() === 'compact' ? colorData.textClass + '!' : 'text-gray-600'"
              [class.shadow-sm]="layoutMode() === 'compact'"
              (click)="setLayoutMode('compact')"
              aria-label="Compact view"
              title="Compact view"
              class="transition-all"
            >
              <mat-icon>view_stream</mat-icon>
            </button>
            <button
              mat-icon-button
              [class.bg-white!]="layoutMode() === 'full'"
              [class]="layoutMode() === 'full' ? colorData.textClass + '!' : 'text-gray-600'"
              [class.shadow-sm]="layoutMode() === 'full'"
              (click)="setLayoutMode('full')"
              aria-label="Full view"
              title="Full view"
              class="transition-all"
            >
              <mat-icon>view_agenda</mat-icon>
            </button>
          </div>
        </div>
      </div>
    }
    <div
      cdkDropList
      cdkDropListOrientation="mixed"
      [cdkDropListDisabled]="!dragDropEnabled()"
      (cdkDropListDropped)="onItemDrop($event)"
      [class.gap-3]="layoutMode() === 'full'"
      [class.gap-2]="layoutMode() !== 'full'"
      class="select-none grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 px-2 sm:px-4"
    >
      @for (item of checklistItems(); track item.id) {
        <div
          class="relative"
          [class.rounded-xl]="layoutMode() === 'full'"
          [class.rounded-lg]="layoutMode() !== 'full'"
          (click)="$event.stopPropagation()"
        >
          <!-- Action buttons behind the card -->
          <div
            class="absolute right-0 top-0 bottom-0 flex items-center gap-2 px-2 z-10 transition-opacity duration-200"
            [style.background-color]="getChecklistColor()"
            [class.opacity-100]="isItemSwiped(item)"
            [class.opacity-0]="!isItemSwiped(item)"
            [class.pointer-events-none]="!isItemSwiped(item)"
            [class.pointer-events-auto]="isItemSwiped(item)"
            [class.rounded-tr-xl]="layoutMode() === 'full' && isItemSwiped(item)"
            [class.rounded-br-xl]="layoutMode() === 'full' && isItemSwiped(item)"
            [class.rounded-tr-lg]="layoutMode() !== 'full' && isItemSwiped(item)"
            [class.rounded-br-lg]="layoutMode() !== 'full' && isItemSwiped(item)"
          >
            <button
              mat-icon-button
              (click)="openEditItemDialog(item); closeSwipe(); $event.stopPropagation()"
              aria-label="Edit item"
              class="flex! items-center! w-12! h-12! text-white! hover:bg-white/20!"
            >
              <mat-icon class="text-2xl!">edit</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="deleteItem(item); closeSwipe(); $event.stopPropagation()"
              aria-label="Delete item"
              class="flex! items-center! w-12! h-12! text-white! hover:bg-white/20!"
            >
              <mat-icon class="text-2xl!">delete</mat-icon>
            </button>
          </div>

          <!-- Card content -->
          <div
            cdkDrag
            class="checklist-item flex justify-between items-center border relative group overflow-hidden"
            [class.cursor-move]="dragDropEnabled()"
            [class.cursor-default]="!dragDropEnabled()"
            [class.transition-all]="!dragDropEnabled()"
            [class.duration-300]="!dragDropEnabled()"
            [class.p-4]="layoutMode() === 'full'"
            [class.p-3]="layoutMode() === 'compact'"
            [class.rounded-xl]="layoutMode() === 'full' && !isItemSwiped(item)"
            [class.rounded-tl-xl]="layoutMode() === 'full' && isItemSwiped(item)"
            [class.rounded-bl-xl]="layoutMode() === 'full' && isItemSwiped(item)"
            [class.rounded-lg]="layoutMode() !== 'full' && !isItemSwiped(item)"
            [class.rounded-tl-lg]="layoutMode() !== 'full' && isItemSwiped(item)"
            [class.rounded-bl-lg]="layoutMode() !== 'full' && isItemSwiped(item)"
            class="{{
              item.isDone
                ? colorData.bgClass + ' ' + colorData.borderClass + ' ' + colorData.textClass
                : 'bg-white border-gray-200'
            }}"
            [style.border-color]="item.isDone ? colorData.textClass : undefined"
            [class.shadow-sm]="!item.isDone"
            [class.shadow-md]="item.isDone"
            [class.hover:shadow-md]="!item.isDone"
            [class.hover:border-gray-300]="!item.isDone"
            [style.transform]="
              isItemSwiped(item) && !dragDropEnabled() ? 'translateX(-120px)' : 'translateX(0)'
            "
            (touchstart)="onTouchStart($event, item)"
            (touchmove)="onTouchMove($event, item)"
            (touchend)="onTouchEnd($event, item)"
            (mousedown)="onMouseDown($event, item)"
            (mouseleave)="onMouseLeave()"
            (click)="!isItemSwiped(item) && !mouseStarted && toggleItemDone(item)"
          >
            <div class="flex-1 flex items-center gap-3 sm:gap-4 min-w-0">
              <!-- Drag handle visual indicator -->
              @if (dragDropEnabled()) {
                <div
                  cdkDragHandle
                  class="shrink-0 cursor-grab active:cursor-grabbing{{
                    item.isDone ? colorData.textClass : ' text-gray-400 hover:text-gray-600'
                  }} transition-colors"
                  aria-label="Drag handle"
                >
                  <mat-icon class="text-xl sm:text-2xl">drag_indicator</mat-icon>
                </div>
              }
              <div
                class="shrink-0 cursor-pointer active:scale-95"
                [class.transition-transform]="!dragDropEnabled()"
                (click)="toggleItemDone(item); $event.stopPropagation()"
                (mousedown)="$event.stopPropagation()"
              >
                @if (item.isDone) {
                  <mat-icon [class]="'text-2xl sm:text-3xl ' + getTextColorClass('600')"
                    >check_circle</mat-icon
                  >
                } @else {
                  <mat-icon class="text-2xl sm:text-3xl text-gray-400 group-hover:text-gray-500"
                    >radio_button_unchecked</mat-icon
                  >
                }
              </div>
              <div
                class="flex-1 min-w-0 cursor-pointer"
                (click)="toggleItemDone(item); $event.stopPropagation()"
              >
                <h3
                  class="font-medium mb-1 flex gap-1.5 sm:gap-2 items-center"
                  [class.text-base]="layoutMode() === 'full'"
                  [class.text-sm]="layoutMode() === 'compact'"
                  [class.text-gray-900]="!item.isDone"
                  [class]="item.isDone ? getTextColorClass('900') : ''"
                  [class.line-through]="item.isDone"
                  [class.opacity-60]="item.isDone"
                >
                  @if (item.icon) {
                    <mat-icon class="align-middle shrink-0 text-lg sm:text-xl">{{
                      item.icon
                    }}</mat-icon>
                  }
                  <span class="truncate">{{ item.title }}</span>
                </h3>
                @if (item.description && layoutMode() === 'full') {
                  <p
                    class="text-sm m-0 mt-1 whitespace-pre-wrap text-gray-600 leading-relaxed"
                    [class.text-gray-500]="!item.isDone"
                    [class]="item.isDone ? colorData.textClass : ''"
                    [class.opacity-70]="item.isDone"
                  >
                    {{ item.description }}
                  </p>
                }
                @if (item.subItems && item.subItems.length > 0 && layoutMode() === 'full') {
                  <div class="flex flex-wrap gap-1.5 mt-2">
                    @for (subItem of item.subItems; track subItem) {
                      <span
                        class="inline-flex items-center px-1.5 py-0.5 {{
                          item.isDone
                            ? colorData.borderClass + ' ' + colorData.textClass
                            : 'bg-gray-100 text-gray-600'
                        }} rounded-full text-xs font-normal border border-gray-200"
                        [class.opacity-60]="item.isDone"
                      >
                        {{ subItem }}
                      </span>
                    }
                  </div>
                }
              </div>
            </div>
            <!-- Desktop hover buttons -->
            @if (layoutMode() === 'full') {
              <div
                class="hidden sm:flex gap-0.5 sm:gap-1 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity"
              >
                <button
                  mat-icon-button
                  (click)="openEditItemDialog(item); $event.stopPropagation()"
                  [class]="colorData.textClass"
                  aria-label="Edit item"
                  class="flex! content-center! items-center! w-8! h-8! sm:w-12! sm:h-12!"
                >
                  <mat-icon class="text-lg! sm:text-xl!">edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteItem(item); $event.stopPropagation()"
                  aria-label="Delete item"
                  class="flex! content-center! items-center! w-8! h-8! sm:w-12! sm:h-12!"
                >
                  <mat-icon class="text-lg! sm:text-xl!">delete</mat-icon>
                </button>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
